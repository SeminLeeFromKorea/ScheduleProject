<html xmlns:th="http://www.thymeleaf.org">
<link rel="stylesheet" type="text/css" href="/assets/css/modal.css" />

</script>
<th:block th:replace="~{./include/basicLayout :: 함수( ~{:: .wrap } ) }">


	<div class="wrap">
		<main id="main" class="main">
			<form name="projectForm" action="registForm" method="post">
				<div class="pagetitle">
					<h1>프로젝트 생성</h1>
				</div>


				<section class="section">
					<div class="row" style="justify-content: center">
						<div class="col-lg-7">
							<div class="card">
								<div class="card-body">
									<h5 style="text-align: center; font-size: 18px; font-weight: 500; padding-top: 20px">프로젝트 생성</h5>
									<hr />
									<form action="/project/projectStarted">
										<div>

											<span>프로젝트 명</span> <input class="form-control" type="text" name="pj_name" placeholder="프로젝트 제목을 입력하세요." required><br>

											<div style="padding-bottom: 50px">
												<div style="float: left; width: 50%">
													<span>프로젝트 시작일</span> <input type="date" class="form-control" name="pj_startdate" required>
												</div>
												<div style="float: right; width: 50%">
													<span>프로젝트 종료일</span> <input type="date" class="form-control" name="pj_enddate" required>
												</div>
											</div>

											<div style="padding-top: 40px">
												<span>프로젝트 상세 설명</span>
												<textarea class="form-control" type="text" name="pj_description" placeholder="프로젝트에 관한 설명을 입력하세요." style="height: 200px;" required></textarea>
												<div></div>

												<div>
													<!-- 팀원 목록 -->
													<div style="float: left; width: 49%; padding-top: 30px">
														<span>팀원 목록</span>
														<div name=finalMember class="form-control" type="text" style="height: 200px; overflow: auto;" readonly>
															<!-- 
                                             <p name="pj_member"><i style="color: red" class="bi bi-dash-circle red"></i> 강민정</p>
                                             <p name="pj_member"><i style="color: red" class="bi bi-dash-circle red"></i> 강민정</p>
                                             <p name="pj_member"><i style="color: red" class="bi bi-dash-circle red"></i> 강민정</p>
                                             <p name="pj_member"><i style="color: red" class="bi bi-dash-circle red"></i> 강민정</p>
                                             <p name="pj_member"><i style="color: red" class="bi bi-dash-circle red"></i> 강민정</p>
                                             <p name="pj_member"><i style="color: red" class="bi bi-dash-circle red"></i> 강민정</p>
                                             -->
														</div>
														<div style="padding-top: 10px">
															<button class="modalOn btn btn-primary w-20">팀원 초대</button>
														</div>
													</div>

													<!-- 옵저버 목록 -->
													<div style="float: right; width: 49%; padding-top: 30px">
														<span>옵저버 목록</span>
														<div class="form-control" type="text" style="height: 200px; overflow: auto;" readonly>
															<p name="pj_observermember">
																<i style="color: red" class="bi bi-dash-circle red"></i> 강민정
															</p>
															<p name="pj_observermember">
																<i style="color: red" class="bi bi-dash-circle red"></i> 강민정
															</p>
															<p name="pj_observermember">
																<i style="color: red" class="bi bi-dash-circle red"></i> 강민정
															</p>
															<p name="pj_observermember">
																<i style="color: red" class="bi bi-dash-circle red"></i> 강민정
															</p>
															<p name="pj_observermember">
																<i style="color: red" class="bi bi-dash-circle red"></i> 강민정
															</p>
															<p name="pj_observermember">
																<i style="color: red" class="bi bi-dash-circle red"></i> 강민정
															</p>
														</div>
														<div style="padding-top: 10px"></div>
														<button class="modalOn btn btn-primary w-20" style="float: left;">옵저버 초대</button>
													</div>
												</div>

												<div align="center">
													<button class="btn btn-primary w-20" type="submit" style="margin-top: 30px;">프로젝트 생성</button>
												</div>

											</div>

										</div>
								</div>
							</div>
				</section>
			</form>

			<!-- 모달창 -->
			<div id="basicModal" class="modal-overlay">
				<div class="modal-content">
					<p class="title" style="padding-top: 20px"></p>

					<div class="content">
						<div class="sub-form">

							<div>
								<div style="float: left; width: 49%;">

									<p>전체 목록</p>
									<div class="form-control" type="text" style="height: 400px; overflow: auto;" required>
										<div style="display: flex;">
											<div class="depListWrap"></div>
											<div class="depMemberListWrap"></div>
										</div>
									</div>

									<div style="padding-top: 10px">
										<button type="button" class="btn btn-primary w-20" onclick="teamPlus(event)">추가</button>
									</div>

								</div>

								<div style="float: right; width: 49%" required>
									<p style="float: left">추가 목록</p>
									<p style="float: right" class="allMember">
										일괄 삭제 <input type=checkbox name="memberDelete" style="padding: 10px" onclick="selectAllMember(this)">
									</p>
									<div id=teamName class="form-control" type="text" style="height: 400px; overflow: auto;" readonly></div>
									<div style="padding-top: 10px"></div>
									<button type="button" onclick="memberDelete2()" class="btn btn-primary w-20" style="float: left;">삭제</button>
								</div>
							</div>

						</div>
					</div>

					<div align="center">
						<button type="button" onclick="memberSuccess()" class="modalOff btn btn-primary w-20" style="margin-top: 30px">완료</button>
					</div>
				</div>


			</div>

		</main>

	</div>

</th:block>

<script src="/assets/js/modal.js"></script>
<script th:inline="javascript">
//모달에서 일괄 삭제 전체 선택 기능
    $(".modalOn").click(function(e) {
        $("#basicModal").children().find(".title").html(e.target.innerHTML);
    });

      function selectAllMember(selectAll){
         const checkboxes = document.getElementsByName('memberDelete');
           
          checkboxes.forEach((checkbox) => {
             checkbox.checked = selectAll.checked;
           })    
      }

//ajax로 부서 출력
   $(document).ready(function() {
      $.ajax({
         url: "../getDepList",
         type: "get",
         success: function(result) {
            var str = "";
                str += '<ul class="depList" style="position: relative; list-style: none;" onclick="getDepList(event);">';
                result.forEach(function(item, index) {
                   str += '<li class="depList" style="cursor: pointer; padding-bottom: 10px; padding-top: 5px;" value='+ JSON.stringify(item.department_id) +'>'+ item.department_name +'</li>';
                })
                str += '</ul>';
            
                $(".depListWrap").append(str); //자식으로 추가
         },
         error: function(err) {
            alert("카테고리 조회에 실패했습니다. 담당자에게 문의하세요.");
         }
      });
   });   
   
//ajax로 부서 클릭 시 부서에 있는 팀원 목록 출력
function getDepList(e){
   $.ajax({
      url: "../getDepMemberList",
      type: "get",
      data: { department_id : e.target.value },
      success: function(result) {         
         var str = "";
            str += '<ul class="depMemberList" style="position: relative; list-style: none;">';
            result.forEach(function(item, index) {
               str += `<li class="depMemberList2" onclick="seleted(event)" data-value="${item.user_id}" style="padding-bottom: 10px; padding-top: 5px; cursor: pointer"` + `>` 
               + item.user_name
 			   + '</li>';
            })
            str += '</ul>';

            // 기존 자식 요소들을 모두 제거하고, 새로운 요소들을 추가함
            $(".depMemberListWrap").empty().append(str);

            // 새로 추가한 요소들에 대해 .category_remove() 함수 호출
            $('.depMemberList2').category_remove();
      },
      error: function(err) {
         alert("카테고리 조회에 실패했습니다. 담당자에게 문의하세요.");
      }
   });
   
   $('.depMemberList2').category_remove();
}

//다른 부서 눌렀을 때 이전 팀원 목록 삭제
$.fn.category_remove = function() {
   // 현재 요소 내부에서 .depMemberListWrap 요소만 선택하여 내용을 지움
    this.find('.depMemberListWrap').empty();
}


//이름을 선택 하고 추가를 누를 때 추가 목록에 이름이 들어가고 동일한 사람 추가 방지
var teamPlus = function(e) {
    const teamList = document.querySelectorAll('.selected');
    const allMember = document.querySelector('.allMember').children;
    
    //전체 목록 div
    const teamNameDiv = document.getElementById('teamName');
     Array.from(allMember).forEach(function(element) {
         element.checked = false;
     });
    
    teamList.forEach(function(element, index) {
       const name = teamList[index].innerHTML;
       const name2 = teamList[index].dataset.value;
       const value = teamList[index].getAttribute('value');
        const existingMembers = teamNameDiv.querySelectorAll('[name="member"]');
        const isMemberExist = Array.from(existingMembers).some(function(member) {
            return member.textContent === name;
        }); 
        
        //없는 이름이라면 추가해준다
        if (!isMemberExist) {
           //p태그의 속성 지정
            const newListItem = document.createElement('div');
            newListItem.setAttribute('name', 'member');
            
            //input의 속성 지정
            const newInput = document.createElement('input');
            newInput.setAttribute('type', 'checkbox');
            newInput.setAttribute('name', 'memberDelete');
            newInput.style.margin = '0px 20px 20px 0px';
            
            //p태그의 자식으로 input을 넣어주고 이름 넣어주기
            newListItem.appendChild(newInput);
            newListItem.appendChild(document.createTextNode(name));
            newListItem.setAttribute('value', name2);
            teamNameDiv.appendChild(newListItem);
            
        }
            //추가가 되면 기존에 선택했던 팀원들 색 지워줌
            element.classList.remove('selected');
            element.style.color = '';
            element.style.backgroundColor = 'white';
    });
 
};

//선택 했을 때 색상 변경 
var seleted = function(e) {
  e.target.classList.toggle('selected');
  e.target.style.backgroundColor = e.target.classList.contains('selected') ? '#00acac' : 'white';
  e.target.style.color = e.target.classList.contains('selected') ? 'white' : '';
  e.target.style.cursor = "pointer";
}

//삭제 버튼 누를 때 안에 있는 태그 삭제
function memberDelete2() {
    // teamName 요소 선택하기
    const teamNameElement = document.querySelectorAll('[name="member"]');
    var i = 0;
    teamNameElement.forEach(function(element) {
        if (teamNameElement[i].children[0].checked) {
            teamNameElement[i].remove();  
        }
        i++;
    });
}

//모달창에서 완료 누르면 태그에 있는 이름 값 생성 창으로 넘기기
function memberSuccess(){
	 var finalMember = document.querySelectorAll('[name="member"]');
	 console.log(finalMember);
	  var finalMemberName = finalMember[0].children;
	  console.log(finalMemberName);
	  //console.log("finalMemberName: " + finalMemberName);
	
	//div 값에 children으로 태그를 추가 해야 한다.
	var finalMember2 = document.getElementsByName('finalMember');
	//console.log(finalMember);
	
	// 새로운 p 태그 생성
	var newPTag = document.createElement('p');
	var newITag = document.createElement('i');
	
	// p 태그에 name 속성 지정
	newPTag.setAttribute('name', 'member');
	
	// i 태그 속성 지정
	newITag.setAttribute('class', 'bi bi-dash-circle red');
	newITag.style.color = 'red';

	// 생성한 p 태그를 finalMember2 변수에서 선택한 p 태그 요소의 부모 요소에 추가
	var i = finalMember2[0].appendChild(newPTag);
	newPTag.appendChild(newITag);
	//console.log(i);
	
	const teamList = document.querySelectorAll('.selected');
    const allMember = document.querySelector('.allMember').children;
    const teamNameDiv = document.getElementById('teamName');
    //console.log(teamList);
    //console.log(allMember);
    //console.log(teamNameDiv);

}

</script>

</html>